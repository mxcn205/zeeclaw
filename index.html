<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Open When…</title>

  <style>
    :root{
      --text:#eaf0ff;

      --pink:#FFE6EE;
      --pink-2:#FFD6E3;
      --pink-3:#FFF1F6;
      --pink-border: rgba(80,20,40,.18);
      --pink-border-2: rgba(80,20,40,.12);
      --pink-text:#3a1222;
      --pink-text-muted: rgba(58,18,34,.72);

      --accent:#FF6FA7;
      --accent-2:#B77BFF;
    }
    *{box-sizing:border-box}

    body{
      margin:0;
      font-family: "Century Gothic", "URW Gothic L", "Tw Cen MT", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      min-height:100vh;

      display:flex;
      justify-content:center;
      align-items:center;
      padding:24px 16px;

      background-image: url("assets/backgrounds/ZeeArcadeBackground.jpeg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    body::before{
      content:"";
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      pointer-events:none;
      z-index:-1;
    }

    .wrap{width:min(1100px,100%)}

    .homeGrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:22px;
      width:min(900px, 100%);
      margin:0 auto;
    }
    @media (max-width: 820px){
      .homeGrid{ grid-template-columns: 1fr; width:min(520px, 100%); }
    }

    .homeCard{
      position:relative;
      overflow:hidden;
      border-radius:26px;
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease;
      backdrop-filter: blur(6px);
      min-height: 280px;
    }
    .homeCard:hover{ transform: translateY(-2px); border-color: rgba(124,92,255,.55); }
    .homeCard:active{ transform: translateY(0px); }

    .homeMedia{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.10);
    }
    .homeMedia img{
      width: 82%;
      height: 82%;
      object-fit: contain;
      filter: drop-shadow(0 16px 24px rgba(0,0,0,.35));
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none;
    }

    .homeOverlay{
      position:absolute;
      left:0; right:0; bottom:0;
      padding:16px 16px 14px;
      background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.58));
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .homeTitle{
      margin:0;
      font-weight:900;
      letter-spacing:.2px;
      font-size: 20px;
    }
    .homeBlurb{
      margin:0;
      color: rgba(234,240,255,.88);
      font-size: 14px;
      line-height: 1.25;
    }

    /* Popup */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(900px, 100%);
      background: var(--pink);
      color: var(--pink-text);
      border:1px solid var(--pink-border);
      border-radius:22px;
      overflow:hidden;
      box-shadow: 0 30px 80px rgba(0,0,0,.35);
    }

    .modalTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 16px;
      border-bottom:1px solid var(--pink-border-2);
      background: var(--pink-2);
    }
    .modalTop .mtitle{ font-weight:900; letter-spacing:.2px; }

    .btn{
      appearance:none;
      border:1px solid var(--pink-border);
      background: rgba(255,255,255,.55);
      color: var(--pink-text);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      transition: transform .1s ease, background .1s ease, border-color .1s ease;
      font-weight:800;
      letter-spacing:.2px;
    }
    .btn:hover{ background: rgba(255,255,255,.75); border-color: rgba(80,20,40,.25); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px); }

    .btnPrimary{
      background: linear-gradient(135deg, rgba(255,111,167,.95), rgba(183,123,255,.75));
      border-color: rgba(80,20,40,.14);
      color: #ffffff;
      text-shadow: 0 1px 0 rgba(0,0,0,.12);
    }
    .btnPrimary:hover{
      background: linear-gradient(135deg, rgba(255,111,167,1), rgba(183,123,255,.85));
    }

    .modalBody{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:0;
      min-height: 540px;
    }
    @media (max-width: 900px){
      .modalBody{ grid-template-columns: 1fr; }
    }

    .machinePane{
      padding:14px;
      border-right:1px solid var(--pink-border-2);
      background: transparent;
    }

    .machine{
      width:100%;
      aspect-ratio: 16/11;
      border-radius:18px;
      border:1px solid var(--pink-border);
      background: rgba(255,255,255,.35);
      position:relative;
      overflow:hidden;
    }

    .playfield{
      position:absolute;
      left:12px; right:12px;
      top:12px;
      bottom:70px;
      border-radius:14px;
      border:1px solid var(--pink-border);
      overflow:hidden;
      z-index:1;
      background: rgba(255,255,255,.20);
    }

    /* ✅ Small drop box on the left (inside playfield) */
    .dropZone{
      position:absolute;
      left:10px;
      bottom:10px;
      width:92px;
      height:64px;
      border-radius:14px;
      border:1px solid rgba(80,20,40,.22);
      background: rgba(255,255,255,.45);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.25);
      z-index:5;
    }
    .dropZone::after{
      content:"";
      position:absolute;
      inset:10px 10px 12px;
      border-radius:12px;
      border:1px dashed rgba(80,20,40,.18);
      background: rgba(255,255,255,.18);
    }

    .glass{
      position:absolute; inset:0;
      background:
        linear-gradient(115deg, rgba(255,255,255,.35), rgba(255,255,255,0) 35%),
        linear-gradient(250deg, rgba(255,255,255,.25), rgba(255,255,255,0) 40%);
      opacity: .35;
      pointer-events:none;
      z-index:6;
      mix-blend-mode: screen;
    }

    .prize{
      position:absolute;
      width: var(--prizeSize, 92px);
      height: var(--prizeSize, 92px);
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      z-index:2;
      transform: translate(-50%, -50%) rotate(var(--rot, 0deg));
      transition: transform .18s ease, opacity .18s ease, filter .18s ease;
      background: transparent;
      border: none;
      box-shadow: none;
      border-radius: 0;
      padding: 0;
    }
    .prize img{
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events:none;
      -webkit-user-drag:none;
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.22));
    }
    .prize.grabbed{
      filter: drop-shadow(0 0 14px rgba(255,111,167,.65));
    }

    .clawRig{
      position:absolute;
      left:0; right:0;
      top:-6px;
      height:190px;
      pointer-events:none;
      z-index:4;
    }
    .rail{
      position:absolute; left:0; right:0; top:6px;
      height:12px;
      background: rgba(255,255,255,.40);
      border-bottom:1px solid rgba(80,20,40,.10);
    }
    .cable{
      position:absolute;
      width:4px;
      top:18px;
      height:90px;
      background: rgba(80,20,40,.18);
      border-radius:999px;
      left:50%;
      transform: translateX(-50%);
    }

    .clawBox{
      position:absolute;
      top:18px;
      left:10%;
      transform: translateX(-50%);
      width: 160px;
      height: 160px;
      pointer-events:none;
      filter: drop-shadow(0 10px 10px rgba(0,0,0,.18));
    }
    .clawImg{
      width:100%;
      height:100%;
      object-fit: contain;
      object-position: center;
      display:block;
    }

    .controls{
      position:absolute; left:12px; right:12px; bottom:12px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      background: rgba(255,255,255,.55);
      border:1px solid var(--pink-border);
      border-radius:14px;
      padding:10px;
      z-index:7;
    }
    .hint{ color: var(--pink-text-muted); font-size:12.5px; line-height:1.2; }
    .status{
      font-size:12.5px;
      color: var(--pink-text);
      padding:6px 10px;
      border:1px solid var(--pink-border);
      border-radius:999px;
      background: rgba(255,255,255,.55);
      white-space:nowrap;
      min-width: 140px;
      text-align:center;
    }

    .sidePane{ padding:14px; background: transparent; }
    .panelBox{
      border-radius:18px;
      border:1px solid var(--pink-border);
      background: var(--pink-3);
      padding:14px;
      min-height:100%;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .revealTitle{ font-weight:900; letter-spacing:.3px; margin:0; }
    .revealCard{
      border-radius:16px;
      border:1px dashed rgba(80,20,40,.25);
      padding:12px;
      background: rgba(255,255,255,.55);
      flex:1;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:10px;
    }
    .revealCard .big{ font-size:14px; color: var(--pink-text-muted); line-height:1.5; }

    /* ✅ slightly bigger message text */
    .revealCard .msg{
      font-size:15.5px;   /* was 14.5px */
      line-height:1.65;
      white-space:pre-wrap;
    }

    .hidden{ display:none !important; }
    .pulse{ animation: pulse .9s ease-in-out infinite; }
    @keyframes pulse{
      0%,100%{ transform:scale(1); opacity:.95; }
      50%{ transform:scale(1.02); opacity:1; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="homeGrid" id="promptGrid"></div>
  </div>

  <div class="modalBackdrop" id="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Claw Machine">
      <div class="modalTop">
        <div class="mtitle" id="modalTitle">Open when…</div>
        <div style="display:flex; gap:10px;">
          <button class="btn" id="resetBtn" type="button">Reset prizes</button>
          <button class="btn" id="closeBtn" type="button">Close</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="machinePane">
          <div class="machine" id="machine">
            <div class="playfield" id="playfield">
              <!-- ✅ drop box -->
              <div class="dropZone" aria-hidden="true"></div>

              <div class="clawRig">
                <div class="rail"></div>
                <div class="cable" id="cable"></div>
                <div class="clawBox" id="clawBox">
                  <img class="clawImg" id="claw" src="assets/machine/ZeeClawOpen.png" alt="claw" />
                </div>
              </div>
              <div class="glass"></div>
            </div>

            <div class="controls">
              <div class="hint" id="hintText">Press DROP CLAW to grab a prize.</div>
              <div style="display:flex; gap:10px; align-items:center;">
                <span class="status" id="statusPill">Ready</span>
                <button class="btn btnPrimary" id="dropBtn" type="button">DROP CLAW</button>
              </div>
            </div>
          </div>
        </div>

        <div class="sidePane">
          <div class="panelBox">
            <h3 class="revealTitle">Your message...</h3>

            <div class="revealCard">
              <div class="big pulse" id="revealPlaceholder">Win something to reveal a note…</div>
              <div class="msg hidden" id="revealMsg"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const CLAW_SRC = {
  open:  "assets/machine/ZeeClawOpen.png",
  close: "assets/machine/ZeeClawClose.png",
};

const CLAW_BOX_SIZE = 160;
const PRIZE_TO_CLAW_GRIP = 0.59;
const PRIZE_SIZE = Math.round(CLAW_BOX_SIZE * PRIZE_TO_CLAW_GRIP);

const START_X_PCT = 10;
const START_Y_PX  = 18;
const HOLD_Y_OFFSET_PX = 56;
const GRAB_POINT_Y_FRAC = 0.74;
const MIN_SPAWN_X_PCT = 25;

const HOME_GIFS = {
  happy:   "assets/buttons/ZeeMMHappy.gif",
  stressed:"assets/buttons/ZeeMMStress.gif",
  miss:    "assets/buttons/ZeeMMMiss.gif",
  sad:     "assets/buttons/ZeeMMSad.gif",
};

const PROMPTS = [
  {
    id: "happy",
    title: "Open when you feel happy",
    blurb: "...And a shared joy is a double joy",
    homeGif: HOME_GIFS.happy,
    prizes: [
      { img: "assets/prizes/ZeeGift3.png", note: "No way… wow… my girlfriend is happy… my baby had a good day!!! This is so rare… okay jokes aside I’m glad you’re doing well! You should be proud of yourself even if you being happy isn’t because of some achievement, just be proud that you had a good day, we gotta celebrate these small wins :)" },
      { img: "assets/prizes/ZeeGift.png",  note: "Greetings my cheerful, joyous, and whimsical girl :p I’m glad you’re feeling good! I want to hear all about it :) I can’t wait to hear about how your father got a terminal illness, how you found the PERFECT knee-high boots for ₹100, how you got your 4837th Yuji banger… Whatever it is I’m glad some good has happened in your life :D" },
      { img: "assets/prizes/ZeeHeartEnvelope.png", note: "Hi lovely! I’m glad to hear you’re doing well :) I know you have a lot going on in your life so I’m glad the universe has given you some good days :p Jokes aside you deserve this moment so much sweetheart, and I’m sure you’ll have countless days even better than this one! I love you so much and I hope reading this lifted your mood even higher :>" },
      { img: "assets/prizes/ZeeGift2.png", note: "Wow it’s really your lucky day… you’re already happy AND you found the special message! Send me “hell froze over” and I’ll send you a selfie no matter where I’m at or what I’m doing :) If I’m asleep or don’t respond within an hour I’ll send you a selfie AND a short talking video :p" },
    ]
  },
  {
    id: "stressed",
    title: "Open when you feel stressed",
    blurb: "It's okay, I'm here for you",
    homeGif: HOME_GIFS.stressed,
    prizes: [
      { img: "assets/prizes/ZeeHeartEnvelope.png", note: "Hi my love, I’m not sure what’s causing you to feel stressed, but if it’s something like school, just remember to take breaks, and trust that you’re going to get through this whether it’s a paper or a test you have to study for. You always do a lot better than you expect and you will again!" },
      { img: "assets/prizes/ZeeGift.png", note: "Hi bwabie :p I’m sorry you’re feeling stressed, but I’m sure you’ll be able to get through it! If it’s something you can control like schoolwork, just remember to take breaks and trust that you’ll do well like you always do. If it’s not, maybe talk to me or your mom if you feel like it, if not just try to distract yourself, it’s going to pass and I know you’ll feel better soon! I love you and I’m here if you want to talk okay?" },
      { img: "assets/prizes/ZeeGift3.png", note: "Hi my treasure :) you found the special message! Now you HAVE to send me “I hate you I’m not doing this one” along with one of your assignments for school and I’ll do it for you to take some of your workload :) No but seriously if you’re stressed with some kind of work let me help, you should be relaxing like the princess you are…" },
      { img: "assets/prizes/ZeeMessageInBottle.png", note: "Hi angel, if you’re seeing this you’re probably feeling quite overwhelmed, so no matter what it is, whether or not you can control it, just take a break. Distract yourself or just take some deep breaths and try to relax for 10 minutes or so. If you’re anxious tell yourself that you can worry again after these 10 minutes, but for now just try to calm yourself so you can think better <3" },
    ]
  },
  {
    id: "miss",
    title: "Open when you miss me",
    blurb: "Even though I'm far away, I'm always with you",
    homeGif: HOME_GIFS.miss,
    prizes: [
      { img: "assets/prizes/ZeeMessageInBottle.png", note: "Hi baby, I’m guessing that I’m asleep or busy by the time you’re reading this because otherwise you could just text me, but don’t worry I’m sure we’ll be able to talk soon! Take care of yourself in the meantime okay? Remember to eat your meals, drink water, and don’t stress yourself out too much! I love you and I’m always a call away if you need me :)" },
      { img: "assets/prizes/ZeeHeartEnvelope.png", note: "Hi my love, I miss you so much :(( Even if I’m asleep right now I’m probably dreaming about you and wishing you were here snuggled up against me :p Maybe look through my pictures or pick out some more notes here to read, I’ll be with you soon I’m sure my heart <3" },
      { img: "assets/prizes/ZeeGift.png", note: "Aww darling I miss you too, no matter what it is that I’m doing right now I’m sure it would be so much better with you by my side :( This message is special: if I’m awake send me “VN” in all caps and I’ll send you a 5-minute voice note about what I’ve been up to, if I’m asleep then I’ll send you a 10-minute one when I wake up :)" },
      { img: "assets/prizes/ZeeGift2.png", note: "Hi angel, I’m sorry I can’t be with you right now, if I had the option to I would drop whatever I’m doing to hold you and rock you in my arms. Maybe I should do that… I’m gonna book a flight to India right now… See you soon gorgeous, no more missing me!" },
    ]
  },
  {
    id: "sad",
    title: "Open when you feel sad",
    blurb: "A shared burden is half a burden...",
    homeGif: HOME_GIFS.sad,
    prizes: [
      { img: "assets/prizes/ZeeHeartEnvelope.png", note: "Hi sweetheart, I’m not sure what’s making you sad right now, but what I am sure is that you’ll get through it. You’ve a very strong person and you’ve gotten through worse before. I know it’s hard for you to see a way out of this situation right now, but I don’t want you to trust that the situation will be fixed magically, rather trust that you’re very resilient and you will be okay given some time! If you ever want to talk I’m here for you!" },
      { img: "assets/prizes/ZeeMessageInBottle.png", note: "Hey dear, I’m sorry that you had to go to this section of the app :( If you want to talk about what’s going on with me I’d gladly do so, no matter what it is or what I’m doing right now, I’ll always have time for you :) If you don’t feel like it, that's okay too, just remember to take care of yourself okay? Maybe open a few more of these or distract yourself with a comfort movie. I love you and I’ll be here if you ever need me <3" },
      { img: "assets/prizes/ZeeGift.png", note: "Hi sweetie, I don’t know what exactly is happening right now, but I just wanted to let you know that I’m here with you no matter what it is, and you can always talk to me if you need to vent. If not, maybe you could talk to your mom, or look at pretty outfits on Pinterest to take your mind off things! Everything’s going to be okay my love, and until it’s not you have me, your mom, and your friends to help you deal with it together!" },
      { img: "assets/prizes/ZeeGift2.png", note: "Aww baby I hear you’re going through some tough times right now :( Let me know if I can do anything to help… actually since this is the special message, text me “GIVE ME TWENTY DOLLARS” in all caps for a totally secret mystery prize… and use that prize to get yourself something nice to eat or some pretty clothes to cheer you up a bit :)" },
    ]
  },
];

/** DOM */
const grid = document.getElementById("promptGrid");
const backdrop = document.getElementById("backdrop");
const modalTitle = document.getElementById("modalTitle");
const playfield = document.getElementById("playfield");
const dropBtn = document.getElementById("dropBtn");
const resetBtn = document.getElementById("resetBtn");
const closeBtn = document.getElementById("closeBtn");
const statusPill = document.getElementById("statusPill");
const hintText = document.getElementById("hintText");
const revealPlaceholder = document.getElementById("revealPlaceholder");
const revealMsg = document.getElementById("revealMsg");
const cable = document.getElementById("cable");
const clawBox = document.getElementById("clawBox");
const claw = document.getElementById("claw");

/** State */
let currentPrompt = null;
let prizeElByIndex = new Map();
let remainingIndices = [];
let isBusy = false;

/** Home order requirement */
const HOME_ORDER_IDS = ["sad", "happy", "miss", "stressed"];

function makeHomeCard(p){
  const el = document.createElement("div");
  el.className = "homeCard";
  el.innerHTML = `
    <div class="homeMedia">
      <img src="${p.homeGif}" alt="${p.title}" />
    </div>
    <div class="homeOverlay">
      <p class="homeTitle">${p.title}</p>
      <p class="homeBlurb">${p.blurb}</p>
    </div>
  `;
  el.addEventListener("click", () => openPrompt(p.id));
  return el;
}

HOME_ORDER_IDS
  .map(id => PROMPTS.find(p => p.id === id))
  .filter(Boolean)
  .forEach(p => grid.appendChild(makeHomeCard(p)));

/** Modal */
function openModal(){
  backdrop.style.display = "flex";
  backdrop.setAttribute("aria-hidden", "false");
  document.body.style.overflow = "hidden";
}
function closeModal(){
  backdrop.style.display = "none";
  backdrop.setAttribute("aria-hidden", "true");
  document.body.style.overflow = "";
  currentPrompt = null;
  clearReveal();
  clearPrizes();
  setStatus("ready");
}
closeBtn.addEventListener("click", closeModal);
backdrop.addEventListener("click", (e) => { if(e.target === backdrop) closeModal(); });

function setClawStage(stage){ claw.src = CLAW_SRC[stage]; }

function setStatus(mode){
  if(mode === "grabbing") statusPill.textContent = "Grabbing message...";
  else if(mode === "done") statusPill.textContent = "Message ready!";
  else statusPill.textContent = "Ready";
}

function clearReveal(){
  revealPlaceholder.classList.remove("hidden");
  revealMsg.classList.add("hidden");
  revealMsg.textContent = "";
}
function showReveal(prize){
  revealPlaceholder.classList.add("hidden");
  revealMsg.classList.remove("hidden");
  revealMsg.textContent = prize.note;
}

function clearPrizes(){
  [...prizeElByIndex.values()].forEach(el => el.remove());
  prizeElByIndex.clear();
  remainingIndices = [];
}

function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
function getPlayfieldRect(){ return playfield.getBoundingClientRect(); }

function setClawX(percent){
  const x = clamp(percent, 6, 94);
  clawBox.style.left = `${x}%`;
  cable.style.left = `${x}%`;
}
function setClawY(px){
  const pf = getPlayfieldRect();
  const y = clamp(px, 10, pf.height - CLAW_BOX_SIZE + 8);
  clawBox.style.top = `${y}px`;
  const cableHeight = Math.max(40, Math.min(260, y - 6));
  cable.style.height = `${cableHeight}px`;
}

function tween({from, to, ms, onUpdate}){
  return new Promise(resolve => {
    const start = performance.now();
    function frame(t){
      const p = Math.min(1, (t - start) / ms);
      const eased = p < 0.5 ? 2*p*p : 1 - Math.pow(-2*p+2,2)/2;
      onUpdate(from + (to - from)*eased);
      if(p < 1) requestAnimationFrame(frame);
      else resolve();
    }
    requestAnimationFrame(frame);
  });
}

function getClawCenterInPlayfield(){
  const pf = getPlayfieldRect();
  const cr = clawBox.getBoundingClientRect();
  return { x: (cr.left + cr.width/2) - pf.left, y: (cr.top + cr.height/2) - pf.top };
}
function positionHeldPrize(prizeEl){
  const pf = getPlayfieldRect();
  const c = getClawCenterInPlayfield();
  prizeEl.style.left = `${(c.x / pf.width) * 100}%`;
  prizeEl.style.top  = `${((c.y + HOLD_Y_OFFSET_PX) / pf.height) * 100}%`;
}

function openPrompt(id){
  currentPrompt = PROMPTS.find(p => p.id === id);
  if(!currentPrompt) return;

  modalTitle.textContent = currentPrompt.title;
  openModal();
  clearReveal();
  spawnPrizes(currentPrompt);

  setStatus("ready");
  hintText.textContent = "Press DROP CLAW to grab a prize.";
}

function spawnPrizes(prompt){
  clearPrizes();

  const spots = [
    {x: 28, y: 70}, {x: 40, y: 78}, {x: 52, y: 88},
    {x: 62, y: 72}, {x: 74, y: 80}, {x: 84, y: 86},
    {x: 70, y: 86}, {x: 46, y: 84}, {x: 58, y: 80},
    {x: 88, y: 74}, {x: 80, y: 72},
  ].filter(s => s.x >= MIN_SPAWN_X_PCT);

  const shuffled = [...spots].sort(() => Math.random() - 0.5);

  prompt.prizes.forEach((pr, i) => {
    const spot = shuffled[i % shuffled.length];
    const el = document.createElement("div");
    el.className = "prize";
    el.style.left = `${spot.x}%`;
    el.style.top  = `${spot.y}%`;
    el.style.setProperty("--rot", `${(Math.random()*16-8).toFixed(1)}deg`);
    el.style.setProperty("--prizeSize", `${PRIZE_SIZE}px`);
    el.dataset.index = String(i);
    el.innerHTML = `<img src="${pr.img}" alt="prize" draggable="false" />`;
    playfield.appendChild(el);

    prizeElByIndex.set(i, el);
    remainingIndices.push(i);
  });

  setClawStage("open");
  setClawX(START_X_PCT);
  setClawY(START_Y_PX);
}

function pickAvailableIndex(){
  if(!remainingIndices.length) return null;
  return remainingIndices[Math.floor(Math.random() * remainingIndices.length)];
}
function removeAvailableIndex(idx){
  const k = remainingIndices.indexOf(idx);
  if(k >= 0) remainingIndices.splice(k, 1);
}

async function doPull(){
  if(isBusy || !currentPrompt) return;

  if(!remainingIndices.length){
    setStatus("ready");
    hintText.textContent = "Reset prizes for more!"; // ✅ updated
    return;
  }

  isBusy = true;
  dropBtn.disabled = true;

  setStatus("grabbing");

  const pickedIndex = pickAvailableIndex();
  const pickedPrize = currentPrompt.prizes[pickedIndex];
  const targetEl = prizeElByIndex.get(pickedIndex);

  if(!targetEl){
    removeAvailableIndex(pickedIndex);
    isBusy = false;
    dropBtn.disabled = false;
    setStatus("ready");
    return doPull();
  }

  const pf = getPlayfieldRect();
  const tRect = targetEl.getBoundingClientRect();

  const targetCenterX = (tRect.left + tRect.width/2) - pf.left;
  const targetXPercent = (targetCenterX / pf.width) * 100;

  const targetCenterY = (tRect.top + tRect.height/2) - pf.top;
  const grabPointOffsetPx = CLAW_BOX_SIZE * 0.74;
  let targetClawTopPx = clamp(targetCenterY - grabPointOffsetPx, 10, pf.height - CLAW_BOX_SIZE + 8);

  setClawStage("open");

  await tween({ from: START_X_PCT, to: targetXPercent, ms: 650, onUpdate: v => setClawX(v) });
  await tween({ from: START_Y_PX, to: targetClawTopPx, ms: 520, onUpdate: v => setClawY(v) });

  setClawStage("close");
  targetEl.classList.add("grabbed");
  targetEl.style.setProperty("--rot", "0deg");
  targetEl.style.zIndex = "6";
  targetEl.style.transition = "none";
  positionHeldPrize(targetEl);
  await new Promise(r => setTimeout(r, 140));

  await tween({
    from: targetClawTopPx, to: START_Y_PX, ms: 520,
    onUpdate: v => { setClawY(v); positionHeldPrize(targetEl); }
  });

  await tween({
    from: targetXPercent, to: START_X_PCT, ms: 650,
    onUpdate: v => { setClawX(v); positionHeldPrize(targetEl); }
  });

  setClawStage("open");

  targetEl.style.transition = "transform .35s ease, opacity .35s ease";
  targetEl.style.transform = "translate(-10px, 260px) scale(.92) rotate(-10deg)";
  targetEl.style.opacity = "0";

  await new Promise(r => setTimeout(r, 380));

  targetEl.remove();
  prizeElByIndex.delete(pickedIndex);
  removeAvailableIndex(pickedIndex);

  setStatus("done");
  hintText.textContent = "Prize dropped!";
  showReveal(pickedPrize);

  setTimeout(() => { if(!isBusy) setStatus("ready"); }, 900);

  dropBtn.disabled = false;
  isBusy = false;
}

dropBtn.addEventListener("click", doPull);

resetBtn.addEventListener("click", () => {
  if(!currentPrompt || isBusy) return;
  clearReveal();
  spawnPrizes(currentPrompt);
  setStatus("ready");
  hintText.textContent = "Prizes reshuffled. Press DROP CLAW.";
});

document.addEventListener("keydown", (e) => {
  if(e.key === "Escape" && backdrop.style.display === "flex") closeModal();
});
</script>
</body>
</html>
